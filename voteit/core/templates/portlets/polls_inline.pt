<tal:main xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="voteit.core">
<tal:iterate repeat="obj contents">
  <div class="list-group-item"
      tal:define="can_vote request.has_permission(vote_perm, obj);
                  has_voted request.authenticated_userid in obj;
                  poll_plugin obj.get_poll_plugin()|False;
                  wf_state obj.get_workflow_state();">
    <tal:cog condition="request.is_moderator" replace="structure view.render_template('voteit.core:views/templates/snippets/cogwheel.pt', context = obj)" />

    <tal:broken_plugin condition="not poll_plugin">
      <div class="alert alert-danger" role="alert"
        i18n:translate="broken_poll_notice">The method
        '<tal:ts i18n:name="poll_method" tal:content="obj.poll_plugin"></tal:ts>'
        that this poll uses i missing from this system.
        This poll won't work unless it's restored or changed.</div>
    </tal:broken_plugin>

    <h4>${obj.title}</h4>

    <div tal:content="structure obj.description">Description</div>

    <tal:poll_plugin condition="poll_plugin" tal:define="poll_method_info 'poll_method_info_%s' % obj.uid">
      <p>
        <a class="btn btn-default btn-xs" data-toggle="collapse" href="#${poll_method_info}" aria-expanded="false" aria-controls="${poll_method_info}">
          <span class="glyphicon glyphicon-info-sign"></span>
          ${poll_plugin.title}
        </a>

        <a tal:condition="wf_state == 'closed'" class="btn btn-default btn-xs" href="${request.resource_url(obj, 'poll_raw_data.txt')}">
          <span class="glyphicon glyphicon-save"></span>
          <span i18n:translate="">Ballot data</span>
        </a>
      </p>

      <div class="collapse" id="${poll_method_info}">
        <div class="well">
          ${poll_plugin.description}
        </div>
      </div>

      <a tal:condition="can_vote or has_voted"
        data-open-modal
        class="btn btn-primary"
        href="${request.resource_url(obj, '__vote__')}">
        <span data-actionmarker="glyphicon glyphicon-refresh rotate-me"></span>      
        <span tal:condition="can_vote and not has_voted" i18n:translate="add_vote_button">Vote</span>
        <span tal:condition="can_vote and has_voted" i18n:translate="">Change vote</span>
        <span tal:condition="not can_vote" i18n:translate="">View vote</span>
      </a>
      <a tal:condition="wf_state == 'closed'"
        data-open-modal
        class="btn btn-primary"
        href="${request.resource_url(obj, '__show_results__')}">
        <span data-actionmarker="glyphicon glyphicon-refresh rotate-me"></span>
        <span i18n:translate="">Show results</span>
      </a>
    </tal:poll_plugin>

    <div class="metadata row">
      <div class="col-sm-8">
        <tal:ts i18n:translate="">Participating proposals</tal:ts>: ${len(obj.proposals)}
        <span tal:content="structure view.get_proposal_tag_links(obj)"></span>
      </div>
      <div class="text-right col-sm-4">
        <tal:poll_progress condition="wf_state in ('ongoing', 'closed')">
        <div tal:define="poll_est view.get_voted_estimate(obj)">
          <span class="glyphicon glyphicon-user"></span>
          ${poll_est['percentage']}%
          (${poll_est['added']} / ${poll_est['total']})
          <div class="progress">
            <div class="progress-bar progress-bar-success"
              role="progressbar"
              aria-valuenow="${poll_est['percentage']}"
              aria-valuemin="0"
              aria-valuemax="100"
              style="width: ${poll_est['percentage']}%">
            </div>
          </div>
        </div>
        </tal:poll_progress>
        <tal:def define="is_started wf_state not in ('upcoming', 'private');
                         is_closed wf_state in ('closed', 'canceled');">
        <div>
          <span class="glyphicon glyphicon-time"></span>
        
          <span tal:condition="not is_started" i18n:translate="">Starts</span>
          <span tal:condition="is_started" i18n:translate="">Started</span>
          ${request.dt_handler.format_relative(obj.start_time)|'-'}
        </div>
        <div>
          <span tal:condition="not is_closed" i18n:translate="">Closes</span>
          <span tal:condition="is_closed" i18n:translate="">Closed</span>
          ${request.dt_handler.format_relative(obj.end_time)|'-'}
        </div>
        </tal:def>
      </div>
    </div>
    <div class="metadata">
      <tal:meta replace="structure view.render_view_group('metadata_listing', obj)"></tal:meta>
    </div>
  </div>
</tal:iterate>
<tal:no_polls condition="not contents">
  <div class="list-group-item">
    <span i18n:translate="">No polls yet</span>
  </div>
</tal:no_polls>
</tal:main>
